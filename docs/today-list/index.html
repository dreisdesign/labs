<!DOCTYPE html>
<html lang="en" class="flavor-blueberry theme-light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Today List Footer Demo</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="/labs/design-system/tokens/colors.css">
  <link rel="stylesheet" href="/labs/design-system/styles/flavors.css">
  <link rel="stylesheet" href="/labs/design-system/main.css">
  <script type="module" src="/labs/design-system/components/labs-icon.js"></script>
  <script type="module" src="/labs/design-system/components/labs-button.js"></script>
  <script type="module" src="/labs/design-system/components/labs-footer.js"></script>
  <script type="module" src="/labs/design-system/components/labs-checkbox.js"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: var(--color-background, #f6f6f9);
    }

    labs-footer {
      flex-shrink: 0;
      width: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    #footer-settings-btn labs-icon {
      width: 28px;
      height: 28px;
      transition: transform 0.4s cubic-bezier(.4, 2, .6, 1);
    }

    #footer-settings-btn:hover labs-icon {
      transform: rotate(90deg);
    }
  </style>

  <style>
    #floating-toggles {
      position: fixed;
      top: calc(20px + env(safe-area-inset-top));
      right: calc(20px + env(safe-area-inset-right));
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #flavorToggle {
      height: 48px;
      width: 48px;
      min-width: 48px;
      min-height: 48px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #flavorIcon {
      width: 28px;
      height: 28px;
    }
  </style>
</head>

<body>
  <!-- Floating theme toggle (top right) -->

  <div id="floating-toggles">
    <labs-button id="flavorToggle" variant="icon" aria-label="Switch flavor" title="Switch flavor">
      <labs-icon id="flavorIcon" slot="icon-left" name="colors"
        style="color:var(--color-on-surface); width:28px; height:28px;"></labs-icon>
    </labs-button>
  </div>

  <!-- App header + content container (centered) -->
  <div class="app-container" style="margin-top:18px;">
    <div id="app-header" style="margin-top:0; text-align: center;">
      <h1 id="todayHeader"
        style="margin:0 0 12px; font-size:var(--font-size-h1, 2rem); font-weight:var(--font-weight-heading,700); color:var(--color-on-surface, #333);">
        Today</h1>
    </div>

    <labs-footer full-width elevated>
      <div slot="center">
        <labs-button id="footerAddBtn" pill variant="primary">
          <labs-icon name="add" slot="icon-left" width="20" height="20"></labs-icon>Add
        </labs-button>
      </div>
      <div slot="right" style="display: flex; align-items: center; gap: 8px;">
        <labs-button id="footer-settings-btn" variant="icon" aria-label="Settings" style="padding-right:12px;">
          <labs-icon name="settings" slot="icon-left" width="28" height="28"></labs-icon>
        </labs-button>
      </div>
    </labs-footer>

    <!-- Today list container -->
    <div id="today-wrapper" style="margin: 12px auto 86px;">
      <div id="welcomeCardContainer" style="margin-bottom:12px;"></div>
      <div id="todayItems" role="list" aria-label="Today items" style="display:flex;flex-direction:column;gap:8px;">
      </div>

      <h2 id="archivedTitle" style="margin:18px 0 8px; font-size:1.05rem; display:none;">Archived</h2>
      <div id="archivedItems" role="list" aria-label="Archived items"
        style="display:flex;flex-direction:column;gap:8px;">
      </div>
    </div>

    <!-- Settings Overlay -->
    <labs-overlay id="settingsOverlay">
      <labs-settings-card></labs-settings-card>
    </labs-overlay>

    <!-- Input Overlay (opened when clicking Add) -->
    <labs-overlay id="inputOverlay">
      <labs-input-card></labs-input-card>
    </labs-overlay>

    <script type="module">
      import '/design-system/components/labs-overlay.js';
      import '/design-system/components/labs-settings-card.js';
      import '/design-system/components/labs-input-card.js';
      import '/design-system/components/labs-list-item.js';
    </script>

    <script>
      // Theme management utilities (mirrored from Pad/Today List)
      function applyTheme({ flavor = 'blueberry', theme = 'light' } = {}) {
        const root = document.documentElement;
        root.classList.remove('flavor-vanilla', 'flavor-blueberry', 'flavor-strawberry');
        root.classList.add(`flavor-${flavor}`);
        root.classList.remove('theme-light', 'theme-dark');
        root.classList.add(`theme-${theme}`);
        root.setAttribute('data-color-scheme', theme);
        localStorage.setItem('today-list-theme', theme);
        localStorage.setItem('today-list-flavor', flavor);
        // Update meta theme-color for PWA
        const themeColorMeta = document.querySelector('meta[name="theme-color"]');
        const bgColor = getComputedStyle(root).getPropertyValue('--color-background').trim();
        if (themeColorMeta && bgColor) {
          themeColorMeta.setAttribute('content', bgColor);
        }
        document.dispatchEvent(new CustomEvent('themeChanged'));
      }

      function initSystemTheme(defaultTheme = 'light') {
        const savedTheme = localStorage.getItem('today-list-theme');
        const savedFlavor = localStorage.getItem('today-list-flavor');
        applyTheme({
          flavor: savedFlavor || 'blueberry',
          theme: savedTheme || 'light',
        });
      }

      function updateThemeToggleButton() {
        const themeIcon = document.getElementById('themeIcon');
        const themeButton = document.getElementById('themeToggle');
        const isDark = document.documentElement.classList.contains('theme-dark');
        if (themeIcon) {
          themeIcon.setAttribute('name', isDark ? 'bedtime_off' : 'bedtime');
        }
        if (themeButton) {
          themeButton.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
        }
      }

      function toggleTheme() {
        const isDark = document.documentElement.classList.contains('theme-dark');
        const currentFlavor = getCurrentFlavor();
        applyTheme({ flavor: currentFlavor, theme: isDark ? 'light' : 'dark' });
        updateThemeToggleButton();
      }


      function getCurrentFlavor() {
        const flavors = ['vanilla', 'blueberry', 'strawberry'];
        for (const f of flavors) {
          if (document.documentElement.classList.contains(`flavor-${f}`)) return f;
        }
        return 'blueberry';
      }

      function cycleFlavor() {
        const flavors = ['vanilla', 'blueberry', 'strawberry'];
        const current = getCurrentFlavor();
        const idx = flavors.indexOf(current);
        const next = flavors[(idx + 1) % flavors.length];
        const isDark = document.documentElement.classList.contains('theme-dark');
        applyTheme({ flavor: next, theme: isDark ? 'dark' : 'light' });
      }

      // Initialize theme system
      initSystemTheme();

      // Persistence helpers for Today List items
      const STORAGE_KEY = 'today-list-items-v1';

      function saveItemsToStorage() {
        try {
          const items = [];
          const today = document.getElementById('todayItems');
          const archived = document.getElementById('archivedItems');
          // gather today items
          Array.from(today.children).forEach(child => {
            if (child.tagName && child.tagName.toLowerCase() === 'labs-list-item') {
              items.push({ id: child.getAttribute('data-id') || null, text: child.getAttribute('value') || '', checked: child.hasAttribute('checked'), archived: false });
            }
          });
          // gather archived items
          Array.from(archived.children).forEach(child => {
            if (child.tagName && child.tagName.toLowerCase() === 'labs-list-item') {
              items.push({ id: child.getAttribute('data-id') || null, text: child.getAttribute('value') || '', checked: child.hasAttribute('checked'), archived: true });
            }
          });
          localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
        } catch (e) { console.warn('Could not persist items', e); }
      }

      function loadItemsFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          return JSON.parse(raw);
        } catch (e) { return []; }
      }

      // Render welcome card when empty
      function renderWelcomeIfEmpty() {
        const today = document.getElementById('todayItems');
        const container = document.getElementById('welcomeCardContainer');
        container.innerHTML = '';
        if (!today || today.children.length === 0) {
          const card = document.createElement('div');
          card.style.background = 'var(--color-surface)';
          card.style.border = '1px solid color-mix(in srgb, var(--color-on-surface) 6%, transparent)';
          card.style.padding = '16px';
          card.style.borderRadius = '12px';
          card.style.display = 'flex';
          card.style.flexDirection = 'column';
          card.style.gap = '8px';
          const h = document.createElement('div');
          h.textContent = 'Welcome â€” start your day';
          h.style.fontSize = 'var(--font-size-card-header, 1.125rem)';
          h.style.fontWeight = 'var(--font-weight-card-header, 600)';
          h.style.color = 'var(--color-on-surface)';
          const p = document.createElement('div');
          p.textContent = 'Add your first item to get started. You can archive or remove items and undo actions from the toast.';
          p.style.color = 'var(--color-on-surface-variant, #6b7280)';
          const btn = document.createElement('labs-button');
          btn.setAttribute('pill', '');
          btn.setAttribute('variant', 'primary');
          btn.textContent = 'Add first item';
          btn.addEventListener('click', () => {
            const overlay = document.getElementById('inputOverlay');
            if (overlay && typeof overlay.open === 'function') overlay.open();
          });
          card.appendChild(h);
          card.appendChild(p);
          card.appendChild(btn);
          container.appendChild(card);
        }
      }

      // Hydrate items from storage on load
      function hydrateFromStorage() {
        const items = loadItemsFromStorage();
        if (!items || !items.length) return;
        items.forEach(it => {
          const el = document.createElement('labs-list-item');
          if (it.id) el.setAttribute('data-id', it.id);
          el.setAttribute('value', it.text || '');
          if (it.checked) el.setAttribute('checked', '');
          if (it.archived) document.getElementById('archivedItems').appendChild(el); else document.getElementById('todayItems').appendChild(el);
          // wire events for persistence
          wireItemPersistence(el);
        });
        document.getElementById('archivedTitle').style.display = document.getElementById('archivedItems').children.length ? '' : 'none';
      }

      function wireItemPersistence(item) {
        if (!item) return;
        // when an item requests archive, move DOM and persist; offer undo
        item.addEventListener('archive', (ev) => {
          const today = document.getElementById('todayItems');
          const archived = document.getElementById('archivedItems');
          const archivedTitle = document.getElementById('archivedTitle');
          const previousParent = item.parentElement;
          const snapshot = { parent: previousParent, index: Array.prototype.indexOf.call(previousParent.children, item) };
          archived.prepend(item);
          archivedTitle.style.display = archived.children.length ? '' : 'none';
          saveItemsToStorage();
          renderWelcomeIfEmpty();
          showUndoToast('Item archived', () => {
            if (snapshot.parent && snapshot.parent.insertBefore) snapshot.parent.insertBefore(item, snapshot.parent.children[snapshot.index] || null);
            saveItemsToStorage();
            renderWelcomeIfEmpty();
          });
        });

        // when remove triggered, detach and persist; offer undo
        item.addEventListener('remove', (ev) => {
          const parent = item.parentElement;
          const snapshot = { parent, index: Array.prototype.indexOf.call(parent.children, item) };
          item.remove();
          saveItemsToStorage();
          renderWelcomeIfEmpty();
          showUndoToast('Item removed', () => {
            if (snapshot.parent && snapshot.parent.insertBefore) {
              snapshot.parent.insertBefore(item, snapshot.parent.children[snapshot.index] || null);
              saveItemsToStorage();
              renderWelcomeIfEmpty();
            }
          });
        });

        // toggling checkboxes only needs persistence
        item.addEventListener('toggle', () => { saveItemsToStorage(); });
      }

      document.addEventListener('DOMContentLoaded', () => {
        // Setup flavor switcher button
        const flavorToggle = document.getElementById('flavorToggle');
        if (flavorToggle) {
          flavorToggle.addEventListener('click', cycleFlavor);
        }
        // Settings overlay wiring
        const settingsBtn = document.getElementById('footer-settings-btn');
        const settingsOverlay = document.getElementById('settingsOverlay');
        if (settingsBtn && settingsOverlay) {
          settingsBtn.addEventListener('click', () => settingsOverlay.open());
          // Listen for close event from labs-settings-card
          const settingsCard = settingsOverlay.querySelector('labs-settings-card');
          if (settingsCard) {
            settingsCard.addEventListener('close', () => settingsOverlay.close());
          }
        }

        // Input overlay wiring (Add button)
        const addBtn = document.getElementById('footerAddBtn');
        const inputOverlay = document.getElementById('inputOverlay');
        if (addBtn && inputOverlay) {
          addBtn.addEventListener('click', () => inputOverlay.open());
          const inputCard = inputOverlay.querySelector('labs-input-card');
          if (inputCard) {
            inputCard.addEventListener('close', () => inputOverlay.close());
            inputCard.addEventListener('save', (e) => {
              const { value } = e.detail || {};
              if (value && value.trim()) {
                appendItem(value.trim());
              }
              inputOverlay.close();
            });
          }
        }

        // Demo control buttons
        const archiveDayBtn = document.getElementById('archiveDayBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');
        const simNextDayBtn = document.getElementById('simNextDayBtn');
        if (archiveDayBtn) archiveDayBtn.addEventListener('click', archiveDay);
        if (resetDataBtn) resetDataBtn.addEventListener('click', resetAllData);
        if (simNextDayBtn) simNextDayBtn.addEventListener('click', simulateNextDay);

        // Ensure labs-toast exists for undo actions
        function ensureToast() {
          if (!document.body.querySelector('labs-toast')) {
            const t = document.createElement('labs-toast');
            document.body.appendChild(t);
          }
          return document.body.querySelector('labs-toast');
        }
      });

      // Load persisted items and render welcome state
      document.addEventListener('DOMContentLoaded', () => {
        hydrateFromStorage();
        renderWelcomeIfEmpty();
      });

      // Append item to the today list
      function appendItem(text) {
        const today = document.getElementById('todayItems');
        const archivedTitle = document.getElementById('archivedTitle');
        const archived = document.getElementById('archivedItems');
        const item = document.createElement('labs-list-item');
        const id = `item-${Math.random().toString(36).slice(2, 9)}`;
        item.setAttribute('data-id', id);
        item.setAttribute('value', text);
        today.prepend(item);

        // wire persistence and event handlers
        wireItemPersistence(item);
        saveItemsToStorage();
        renderWelcomeIfEmpty();
      }

      // Archive entire day: move all today items to archived with undo
      function archiveDay() {
        const today = document.getElementById('todayItems');
        const archived = document.getElementById('archivedItems');
        const archivedTitle = document.getElementById('archivedTitle');
        if (!today || !today.children.length) return;
        const moved = [];
        while (today.firstChild) {
          const node = today.firstChild;
          moved.push(node);
          archived.prepend(node);
        }
        archivedTitle.style.display = archived.children.length ? '' : 'none';
        saveItemsToStorage();
        renderWelcomeIfEmpty();
        showUndoToast('Day archived', () => {
          // restore moved nodes back to today in original order
          for (let i = moved.length - 1; i >= 0; i--) {
            today.prepend(moved[i]);
          }
          saveItemsToStorage();
          renderWelcomeIfEmpty();
        });
      }

      // Reset all data: clear storage and DOM with undo
      function resetAllData() {
        const today = document.getElementById('todayItems');
        const archived = document.getElementById('archivedItems');
        const snapshot = { today: Array.from(today.children), archived: Array.from(archived.children) };
        // clear
        today.innerHTML = '';
        archived.innerHTML = '';
        document.getElementById('archivedTitle').style.display = 'none';
        saveItemsToStorage();
        renderWelcomeIfEmpty();
        showUndoToast('All data reset', () => {
          // restore
          snapshot.today.reverse().forEach(n => today.prepend(n));
          snapshot.archived.reverse().forEach(n => archived.prepend(n));
          document.getElementById('archivedTitle').style.display = archived.children.length ? '' : 'none';
          saveItemsToStorage();
          renderWelcomeIfEmpty();
        });
      }

      // Simulate next day: mark as archived state (for testing)
      function simulateNextDay() {
        // simple behavior: move all today items to archived but keep them present (like archiveDay)
        archiveDay();
      }

      // Simple toast helper using existing labs-toast
      function showUndoToast(message, undoFn) {
        try {
          const toast = ensureToast();
          if (toast && typeof toast.show === 'function') {
            toast.show(message, { actionText: 'Undo', duration: 5000 });
            const onAction = () => { undoFn && undoFn(); toast.removeEventListener('action', onAction); };
            toast.addEventListener('action', onAction, { once: true });
          }
        } catch (e) { console.warn('Toast unavailable', e); }
      }
    </script>
</body>

</html>
