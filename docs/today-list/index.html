<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Early theme application to prevent flash -->
    <script>
        // IIFE to apply theme immediately before anything else loads
        (function () {
            try {
                var savedTheme = localStorage.getItem("theme");
                if (savedTheme === "dark") {
                    document.documentElement.classList.add("theme-dark");
                } else {
                    document.documentElement.classList.add("theme-light");
                }
                // Apply to body when it's available
                document.addEventListener('DOMContentLoaded', function () {
                    if (savedTheme === "dark") {
                        document.body.classList.add("theme-dark");
                    } else {
                        document.body.classList.add("theme-light");
                    }
                });
            } catch (e) {
                console.error("Error applying theme:", e);
            }
        })();
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today List - Daily Task Management</title>
    <link rel="icon" type="image/svg+xml" href="../design-system/favicon.svg">

    <!-- Design System Assets -->
    <link rel="stylesheet" href="../design-system/main.css">

    <!-- Components -->
    <script type="module" src="../design-system/components/labs-app-footer.js"></script>
    <script type="module" src="../design-system/components/labs-input-overlay.js"></script>
    <script type="module" src="../design-system/components/labs-task-item.js"></script>
    <script type="module" src="../design-system/components/labs-timestamp.js"></script>
    <script type="module" src="../design-system/components/labs-alert.js"></script>
    <script type="module" src="../design-system/components/labs-badge.js"></script>
    <script type="module" src="../design-system/components/labs-card.js"></script>

    <style>
        /* Minimal override styles - use design system tokens */
        body {
            margin: 0;
            font-family: var(--font-family-base);
            background: var(--color-background);
            color: var(--color-on-background);
            min-height: 100vh;
        }

        /* Match tracker app layout exactly */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 480px;
            margin: 0 auto;
            position: relative;
        }

        /* Remove metric-card styles - now using labs-card component */

        .task-list {
            flex: 1;
            padding: 0 var(--space-md);
            margin-bottom: 80px;
            /* Match tracker footer space */
            overflow-y: auto;
        }

        .placeholder-entry {
            text-align: center;
            color: var(--color-on-surface-variant);
            font-style: italic;
            padding: var(--space-xl);
            opacity: 0.7;
        }

        /* Task item override for completed state */
        labs-task-item.completed {
            opacity: 0.6;
        }

        /* Archived tasks section */
        .archived-section {
            margin-top: var(--space-lg);
            border-top: 1px solid var(--color-outline-variant);
            padding-top: var(--space-lg);
        }

        .archived-header {
            font-size: var(--font-size-h3);
            font-weight: var(--font-weight-medium);
            color: var(--color-on-surface-variant);
            margin-bottom: var(--space-md);
            text-align: center;
        }

        .archived-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--color-surface-container-low);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--color-outline-variant);
            margin-bottom: var(--space-sm);
            transition: all 0.2s ease;
            opacity: 0.6;
        }

        .archived-item:hover {
            background: var(--color-surface-container);
            opacity: 0.8;
        }

        .archived-date {
            font-size: var(--font-size-small);
            color: var(--color-on-surface-variant);
            font-weight: var(--font-weight-medium);
            min-width: 80px;
        }

        .archived-task-text {
            flex: 1;
            font-size: var(--font-size-body);
            color: var(--color-on-surface-variant);
            text-decoration: line-through;
        }

        /* Restore icon (hidden by default, shown on hover) */
        .restore-icon {
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--border-radius-sm);
            background: transparent;
            border: none;
        }

        .archived-item:hover .restore-icon {
            opacity: 0.75;
        }

        .restore-icon:hover {
            opacity: 1 !important;
            background: var(--color-surface-container-high);
        }

        .version-indicator {
            position: fixed;
            top: var(--space-md);
            right: var(--space-md);
            background: var(--color-surface);
            color: var(--color-on-surface);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--space-sm);
            font-family: monospace;
            font-size: var(--font-size-small);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 999;
            opacity: 0.8;
            border: 1px solid var(--color-outline-variant);
        }
    </style>
</head>

<body>
    <!-- Version indicator -->
    <div class="version-indicator">Today List v1.0</div>

    <!-- Main application container -->
    <div class="app">
        <!-- Progress card using design system component -->
        <labs-card title="Today's Progress" variant="stats" width="full"
            style="margin: var(--space-lg) var(--space-md) var(--space-md);">
            <div style="font-size: var(--font-size-h1); font-weight: var(--font-weight-bold); color: var(--color-primary);"
                id="progressValue">0 / 5</div>
        </labs-card>

        <!-- Task list (scrollable) -->
        <div class="task-list" id="task-list">
            <div class="placeholder-entry">Click + Add Task to start your day</div>
        </div>
    </div>

    <!-- Footer using design system component -->
    <labs-app-footer add-label="+ Add Task"></labs-app-footer>

    <!-- Input overlay for adding/editing tasks -->
    <labs-input-overlay id="taskInputOverlay"></labs-input-overlay>

    <script>
        class TodayListApp {
            constructor() {
                this.tasks = this.loadTasks();
                this.init();
            }

            init() {
                this.renderTasks();
                this.updateProgress();
                this.updateDateLabel();
                this.setupEventListeners();
                this.checkForNewDay();
            }

            loadTasks() {
                const stored = localStorage.getItem('today-list-tasks');
                const lastDate = localStorage.getItem('today-list-date');
                const today = new Date().toDateString();

                // Archive previous day's tasks if new day
                if (lastDate && lastDate !== today) {
                    this.archivePreviousDay(lastDate, stored);
                    localStorage.setItem('today-list-date', today);
                    localStorage.removeItem('today-list-tasks'); // Clear today's tasks
                    return [];
                }

                // Set date if first time
                if (!lastDate) {
                    localStorage.setItem('today-list-date', today);
                }

                return stored ? JSON.parse(stored) : [];
            }

            archivePreviousDay(date, tasksJson) {
                if (tasksJson) {
                    const archiveKey = `today-list-archive-${date}`;
                    localStorage.setItem(archiveKey, tasksJson);
                    console.log(`📚 Archived tasks for ${date}`);
                }
            }

            getArchivedDates() {
                const dates = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('today-list-archive-')) {
                        const date = key.replace('today-list-archive-', '');
                        dates.push(date);
                    }
                }
                return dates.sort().reverse(); // Most recent first
            }

            restoreFromDate(date) {
                const archiveKey = `today-list-archive-${date}`;
                const archived = localStorage.getItem(archiveKey);
                if (archived) {
                    const archivedTasks = JSON.parse(archived);
                    // Copy uncompleted tasks
                    const uncompletedTasks = archivedTasks.filter(task => !task.completed);
                    if (uncompletedTasks.length > 0) {
                        if (confirm(`Restore ${uncompletedTasks.length} uncompleted tasks from ${date}?`)) {
                            uncompletedTasks.forEach(task => {
                                task.completed = false; // Ensure they're uncompleted
                                task.id = Date.now() + Math.random(); // New ID
                            });
                            this.tasks = [...this.tasks, ...uncompletedTasks];
                            this.saveTasks();
                            this.renderTasks();
                            this.updateProgress();
                        }
                    } else {
                        alert(`No uncompleted tasks found for ${date}`);
                    }
                }
            }

            restoreSpecificTask(date, taskId) {
                if (this.tasks.length >= 5) {
                    alert('Maximum 5 tasks per day! Complete or edit existing tasks.');
                    return;
                }

                const archiveKey = `today-list-archive-${date}`;
                const archived = localStorage.getItem(archiveKey);
                if (archived) {
                    const archivedTasks = JSON.parse(archived);
                    const taskToRestore = archivedTasks.find(task => task.id == taskId);

                    if (taskToRestore && !taskToRestore.completed) {
                        // Create a copy with new ID
                        const restoredTask = {
                            id: Date.now() + Math.random(),
                            text: taskToRestore.text,
                            completed: false
                        };

                        this.tasks.push(restoredTask);
                        this.saveTasks();
                        this.renderTasks();
                        this.updateProgress();

                        console.log(`✅ Restored task: "${taskToRestore.text}" from ${date}`);
                    }
                }
            }

            saveTasks() {
                localStorage.setItem('today-list-tasks', JSON.stringify(this.tasks));
            }

            renderTasks() {
                const taskList = document.getElementById('task-list');

                if (this.tasks.length === 0) {
                    taskList.innerHTML = '<div class="placeholder-entry">Click + Add Task to start your day</div>';
                } else {
                    taskList.innerHTML = '';
                    this.tasks.forEach((task, index) => {
                        const taskElement = document.createElement('labs-task-item');
                        taskElement.setAttribute('label', task.text);
                        taskElement.setAttribute('task-id', `task-${index}`);
                        taskElement.setAttribute('data-index', index);

                        if (task.completed) {
                            taskElement.setAttribute('checked', '');
                            taskElement.classList.add('completed');
                        }

                        taskList.appendChild(taskElement);
                    });

                    // Setup event listeners for the new task items
                    this.setupTaskEventListeners();
                }

                // Add archived tasks section
                this.renderArchivedTasks(taskList);
            }

            setupTaskEventListeners() {
                // Listen for checkbox changes
                document.addEventListener('labs-checkbox-change', (e) => {
                    const taskItem = e.target.closest('labs-task-item');
                    if (taskItem) {
                        const index = parseInt(taskItem.getAttribute('data-index'));
                        this.toggleTask(index);
                    }
                });

                // Listen for edit events
                document.addEventListener('labs-task-edit', (e) => {
                    const taskItem = e.target.closest('labs-task-item');
                    if (taskItem) {
                        const index = parseInt(taskItem.getAttribute('data-index'));
                        const currentText = this.tasks[index].text;
                        this.openEditOverlay(index, currentText);
                    }
                });

                // Listen for delete events
                document.addEventListener('labs-task-delete', (e) => {
                    const taskItem = e.target.closest('labs-task-item');
                    if (taskItem) {
                        const index = parseInt(taskItem.getAttribute('data-index'));
                        this.deleteTask(index);
                    }
                });
            }

            renderArchivedTasks(taskList) {
                const archivedDates = this.getArchivedDates().slice(0, 3); // Show last 3 days

                if (archivedDates.length > 0) {
                    const archivedSection = document.createElement('div');
                    archivedSection.className = 'archived-section';

                    const archivedHeader = document.createElement('div');
                    archivedHeader.className = 'archived-header';
                    archivedHeader.textContent = 'Recent Archived Tasks';
                    archivedSection.appendChild(archivedHeader);

                    archivedDates.forEach(date => {
                        const archiveKey = `today-list-archive-${date}`;
                        const archived = localStorage.getItem(archiveKey);
                        if (archived) {
                            const archivedTasks = JSON.parse(archived);
                            archivedTasks.forEach(task => {
                                if (!task.completed) { // Only show uncompleted archived tasks
                                    const archivedItem = document.createElement('div');
                                    archivedItem.className = 'archived-item';

                                    const formattedDate = new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                                    archivedItem.innerHTML = `
                                        <div class="archived-date">${formattedDate}</div>
                                        <div class="archived-task-text">${task.text}</div>
                                        <button class="restore-icon" data-date="${date}" data-task-id="${task.id}" aria-label="Restore task">
                                            <labs-icon name="history" color="var(--color-primary)"></labs-icon>
                                        </button>
                                    `;

                                    archivedSection.appendChild(archivedItem);
                                }
                            });
                        }
                    });

                    if (archivedSection.children.length > 1) { // More than just the header
                        taskList.appendChild(archivedSection);
                    }
                }
            }

            addTask(text) {
                if (this.tasks.length >= 5) {
                    alert('Maximum 5 tasks per day! Complete or edit existing tasks.');
                    return;
                }

                this.tasks.push({
                    id: Date.now(),
                    text: text,
                    completed: false
                });
                this.saveTasks();
                this.renderTasks();
                this.updateProgress();
            }

            toggleTask(index) {
                if (this.tasks[index]) {
                    this.tasks[index].completed = !this.tasks[index].completed;
                    this.saveTasks();
                    this.renderTasks();
                    this.updateProgress();
                }
            }

            editTask(index, newText) {
                if (this.tasks[index]) {
                    this.tasks[index].text = newText;
                    this.saveTasks();
                    this.renderTasks();
                    this.updateProgress();
                }
            }

            deleteTask(index) {
                if (this.tasks[index]) {
                    const deletedTask = this.tasks[index];
                    this.tasks.splice(index, 1);
                    this.saveTasks();
                    this.renderTasks();
                    this.updateProgress();

                    // Show undo notification
                    this.showUndoNotification(deletedTask, index);
                }
            }

            showUndoNotification(deletedTask, originalIndex) {
                // Create alert if it doesn't exist
                let alert = document.querySelector('labs-alert');
                if (!alert) {
                    alert = document.createElement('labs-alert');
                    document.body.appendChild(alert);
                }

                // Show the success notification
                alert.show('Task deleted', 'success', 2000);
            }

            updateProgress() {
                const completed = this.tasks.filter(t => t.completed).length;
                const total = this.tasks.length;
                document.getElementById('progressValue').textContent = `${completed} / ${total}`;
            }

            updateDateLabel() {
                const today = new Date();
                const options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                };
                const formattedDate = today.toLocaleDateString('en-US', options);
                document.getElementById('dateLabel').textContent = formattedDate;
            }

            setupEventListeners() {
                // Handle restore button clicks (for archived tasks)
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('restore-icon') || e.target.closest('.restore-icon')) {
                        const restoreButton = e.target.classList.contains('restore-icon') ? e.target : e.target.closest('.restore-icon');
                        const date = restoreButton.dataset.date;
                        const taskId = restoreButton.dataset.taskId;
                        this.restoreSpecificTask(date, taskId);
                    }
                });

                // Footer events - wait for component to be ready
                customElements.whenDefined('labs-app-footer').then(() => {
                    setTimeout(() => {
                        const footer = document.querySelector('labs-app-footer');
                        if (footer) {
                            footer.addEventListener('add-click', () => {
                                this.showAddDialog();
                            });

                            footer.addEventListener('action-click', (e) => {
                                const action = e.detail?.action;
                                if (action === 'reset') {
                                    this.resetTasks();
                                }
                            });
                        }
                    }, 50);
                });

                // Input overlay events
                const inputOverlay = document.getElementById('taskInputOverlay');
                inputOverlay.addEventListener('task-save', (e) => {
                    const { text, index } = e.detail;
                    if (index !== null) {
                        this.editTask(index, text);
                    } else {
                        this.addTask(text);
                    }
                });
            }

            showAddDialog() {
                const inputOverlay = document.getElementById('taskInputOverlay');
                inputOverlay.open('Add Task', 'Enter your task...');
            }

            openEditOverlay(index, currentText) {
                const inputOverlay = document.getElementById('taskInputOverlay');
                inputOverlay.open('Edit Task', 'Enter your task...', currentText, index);
            }

            showEditDialog(text, index) {
                // Legacy method - redirect to new method
                this.openEditOverlay(index, text);
            }

            resetTasks() {
                if (confirm('Reset all tasks and archived data? This will completely clear all your progress and history.')) {
                    // Clear current tasks
                    this.tasks = [];
                    this.saveTasks();

                    // Clear all archived data
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('today-list-archive-')) {
                            keysToRemove.push(key);
                        }
                    }

                    // Remove archived keys
                    keysToRemove.forEach(key => {
                        localStorage.removeItem(key);
                    });

                    this.renderTasks();
                    this.updateProgress();

                    // Also clear any debugging data
                    console.log('🧹 Reset completed - all tasks and archived data cleared');
                }
            }

            showRestoreOptions() {
                const archivedDates = this.getArchivedDates();
                if (archivedDates.length === 0) {
                    alert('No archived tasks found. Complete some tasks and let a day pass to see archived data.');
                    return;
                }

                let options = 'Select a date to restore uncompleted tasks from:\n\n';
                archivedDates.forEach((date, index) => {
                    options += `${index + 1}. ${date}\n`;
                });
                options += '\nEnter the number of your choice (or cancel):';

                const choice = prompt(options);
                if (choice && !isNaN(choice)) {
                    const index = parseInt(choice) - 1;
                    if (index >= 0 && index < archivedDates.length) {
                        this.restoreFromDate(archivedDates[index]);
                    } else {
                        alert('Invalid choice. Please try again.');
                    }
                }
            }

            // Test function to simulate date changes for testing auto-archive
            simulateNewDay() {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayString = yesterday.toDateString();

                // Set the date to yesterday to trigger archive on next check
                localStorage.setItem('today-list-date', yesterdayString);
                console.log(`🧪 Test: Set date to ${yesterdayString}. Reload to trigger archive.`);
                alert(`Test mode: Date set to ${yesterdayString}. Reload the page to trigger auto-archive.`);
            }

            // Test function to create sample archived data for demo
            createTestArchivedData() {
                const testDates = [];
                for (let i = 1; i <= 3; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    testDates.push(date.toDateString());
                }

                const sampleTasks = [
                    { id: 1, text: "Review project proposal", completed: false },
                    { id: 2, text: "Call dentist for appointment", completed: true },
                    { id: 3, text: "Grocery shopping", completed: false },
                    { id: 4, text: "Walk the dog", completed: true },
                    { id: 5, text: "Read chapter 5", completed: false }
                ];

                testDates.forEach((date, index) => {
                    const archiveKey = `today-list-archive-${date}`;
                    const tasksForDate = sampleTasks.slice(index, index + 2); // 2 tasks per day
                    localStorage.setItem(archiveKey, JSON.stringify(tasksForDate));
                });

                console.log('🧪 Test archived data created for last 3 days');
                alert('Test archived data created! Refresh to see archived tasks.');
            } checkForNewDay() {
                // Check every minute for testing (normally would be every hour)
                setInterval(() => {
                    const today = new Date().toDateString();
                    const lastDate = localStorage.getItem('today-list-date');

                    if (lastDate && lastDate !== today) {
                        console.log(`🗓️ New day detected! Previous: ${lastDate}, Current: ${today}`);
                        // Archive current tasks before reloading
                        const currentTasks = localStorage.getItem('today-list-tasks');
                        if (currentTasks) {
                            this.archivePreviousDay(lastDate, currentTasks);
                        }
                        window.location.reload();
                    }
                }, 60000); // Every minute for testing
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            window.todayListApp = new TodayListApp();

            // Expose test functions for debugging
            window.simulateNewDay = () => window.todayListApp.simulateNewDay();
            window.createTestArchivedData = () => window.todayListApp.createTestArchivedData();
            window.showArchivedDates = () => {
                const dates = window.todayListApp.getArchivedDates();
                console.log('📚 Archived dates:', dates);
                return dates;
            };
        });
    </script>
</body>

</html>