<!doctype html>
<html lang="en" class="flavor-blueberry theme-light">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="/labs/tracker/favicon.ico" />
    <title>Labs: Tracker Powered by Smoothie</title>
    <script>// Early theme/flavor script (page-prioritized)
        (function () {
            try {
                var root = document && document.documentElement;
                var body = document && document.body;
                if (!root || !body) return;
                var path = (location && location.pathname) ? location.pathname : '';
                var appMatch = path.match(/(?:\/labs)?\/(tracker|today-list|pad)(?:\/|$)/);
                var appName = appMatch ? appMatch[1] : null;
                var ordered = [];
                if (appName) {
                    ordered.push(appName + '-flavor', appName + '-theme');
                }
                ['today-list-flavor', 'today-list-theme', 'tracker-flavor', 'tracker-theme', 'pad-flavor', 'pad-theme', 'labs-flavor', 'labs-theme'].forEach(function (k) { if (ordered.indexOf(k) === -1) ordered.push(k); });
                var foundFlavor = null;
                var foundTheme = null;
                for (var i = 0; i < ordered.length; i++) {
                    try {
                        var k = ordered[i];
                        var v = localStorage.getItem(k);
                        if (!v) continue;
                        v = String(v).replace(/^flavor-/, '').replace(/^theme-/, '').trim();
                        if (k.indexOf('flavor') !== -1 && !foundFlavor) foundFlavor = v;
                        if (k.indexOf('theme') !== -1 && !foundTheme) foundTheme = v;
                        if (foundFlavor && foundTheme) break;
                    } catch (e) { }
                }
                Array.from(root.classList).forEach(function (c) { if (c && c.indexOf('flavor-') === 0) root.classList.remove(c); });
                Array.from(root.classList).forEach(function (c) { if (c && c.indexOf('theme-') === 0) root.classList.remove(c); });
                Array.from(body.classList).forEach(function (c) { if (c && c.indexOf('flavor-') === 0) body.classList.remove(c); });
                Array.from(body.classList).forEach(function (c) { if (c && c.indexOf('theme-') === 0) body.classList.remove(c); });
                if (foundFlavor) {
                    root.classList.add('flavor-' + String(foundFlavor));
                    body.classList.add('flavor-' + String(foundFlavor));
                }
                if (foundTheme) {
                    root.classList.add('theme-' + String(foundTheme));
                    body.classList.add('theme-' + String(foundTheme));
                }
            } catch (e) { }
        })();
    </script>

    <link rel="stylesheet" href="/labs/design-system/tokens/colors.css">
    <link rel="stylesheet" href="/labs/design-system/styles/flavors.css">
    <link rel="stylesheet" href="/labs/design-system/styles/main.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            background: var(--color-background);
            color: var(--color-on-surface);
        }

        main {
            flex: 1;
            /* width constrained by outer .container-responsive wrapper */
            padding: 24px;
            box-sizing: border-box;
            background: var(--color-background);
            color: var(--color-on-surface);
        }

        #tracker-root {
            display: grid;
            gap: 16px
        }

        labs-footer {
            flex-shrink: 0;
            width: 100%;
            margin: 0;
            padding: 0 12px;
            box-sizing: border-box;
        }

        #footer-settings-btn labs-icon {
            width: 28px;
            height: 28px;
            transition: transform 0.4s cubic-bezier(.4, 2, .6, 1);
        }

        #footer-settings-btn:hover labs-icon {
            transform: rotate(90deg);
        }

        .footer-center {
            display: flex;
            align-items: center;
            gap: 12px;
        }
    </style>
    <style>
        /* Pre-upgrade CSS: stabilize layout before custom elements upgrade */
        :not(:defined) labs-button[fullwidth],
        :not(:defined) labs-button {
            display: block;
            width: 100%;
        }

        :not(:defined) labs-footer {
            min-height: 40px;
        }
    </style>
    <style>
        /* Prevent the tracker list from collapsing to a very narrow width
           when transitioning between empty and populated states. Keep
           layout responsive but provide a sensible minimum width. */
        #list-root>div {
            box-sizing: border-box;
            width: 100%;
            min-width: 280px;
            max-width: 100%;
        }

        /* Ensure empty message uses full width of the list container */
        #list-root .empty {
            width: 100%;
            box-sizing: border-box;
            padding: 12px 0;
        }

        /* Mobile: add padding to main */
        @media (max-width: 640px) {
            main {
                width: 100%;
                padding: 12px;
            }
        }
    </style>
</head>

<body class="flavor-blueberry theme-light">
    <!-- Settings overlay -->
    <labs-overlay id="settingsOverlay" size="medium" transparent>
        <labs-settings-card></labs-settings-card>
    </labs-overlay>

    <main id="app" class="container-responsive">
        <section id="tracker-root">
            <!-- metric card -->
            <div id="metric-root"></div>
            <!-- timestamps list -->
            <div id="list-root"></div>
        </section>
    </main>

    <!-- Footer with settings -->
    <labs-footer full-width elevated>

        <div slot="center" class="footer-center">
            <labs-button id="footer-track-btn" size="large" pill variant="primary" fullwidth>
                <labs-icon name="add" slot="icon-left" width="20" height="20"></labs-icon>Track
            </labs-button>
        </div>

        <div slot="right" style="display: flex; align-items: center; gap: 8px;">
            <labs-button id="footer-settings-btn" variant="icon" aria-label="Settings" title="Settings"
                style="margin-right:20px;">
                <labs-icon name="settings" slot="icon-left" width="22" height="22"></labs-icon>
            </labs-button>
        </div>
    </labs-footer>

    <script type="module" src="/labs/design-system/components/labs-icon.js"></script>
    <script type="module" src="/labs/design-system/components/labs-button.js"></script>
    <script type="module" src="/labs/design-system/components/labs-card.js"></script>
    <script type="module" src="/labs/design-system/components/labs-dropdown.js"></script>
    <script type="module" src="/labs/design-system/components/labs-list-item.js"></script>
    <script type="module" src="/labs/design-system/components/labs-footer.js"></script>
    <script type="module" src="/labs/design-system/components/labs-toast.js"></script>
    <script type="module" src="/labs/design-system/components/labs-overlay.js"></script>
    <script type="module" src="/labs/design-system/components/labs-settings-card.js"></script>
    <script type="module" src="/labs/design-system/components/labs-flavor-button.js"></script>

    <!-- Move main.js to the very end for reliable component definition -->
    <script type="module" src="js/main.js"></script>
    <script type="module">
        // Modular tracker initialization and UI wiring
        import createTracker from './js/main.js';

        document.addEventListener('DOMContentLoaded', () => {
            const tracker = createTracker({ metricRootId: 'metric-root', listRootId: 'list-root' });
            tracker.init();

            const settingsOverlay = document.getElementById('settingsOverlay');
            const settingsBtn = document.getElementById('footer-settings-btn');
            const settingsCard = document.querySelector('labs-settings-card');
            const footerTrackBtn = document.getElementById('footer-track-btn');

            if (settingsBtn && settingsOverlay) settingsBtn.addEventListener('click', () => settingsOverlay.open());

            if (settingsCard && settingsOverlay) {
                settingsCard.addEventListener('close', () => settingsOverlay.close());
                settingsCard.addEventListener('reset-all', () => tracker.resetAll());
            }

            if (footerTrackBtn) footerTrackBtn.addEventListener('click', () => tracker.handleTrack());
        });
    </script>

    <!-- Persist tracker-specific theme/flavor keys when settings change -->
    <script>
        (function () {
            try {
                // When flavor changes via labs-settings-card, it emits 'flavor-changed' with detail { flavor: '...' }
                document.addEventListener('flavor-changed', function (e) {
                    try {
                        var fv = (e && e.detail && e.detail.flavor) ? String(e.detail.flavor).replace(/^flavor-/, '') : null;
                        if (fv) localStorage.setItem('tracker-flavor', fv);
                    } catch (err) { }
                });

                // Observe document.documentElement class changes and persist theme-* class value
                var mo = new MutationObserver(function (mutations) {
                    try {
                        var root = document.documentElement;
                        var themeClass = Array.from(root.classList).find(function (c) { return c && c.indexOf('theme-') === 0; });
                        if (themeClass) {
                            var tv = themeClass.replace('theme-', '');
                            localStorage.setItem('tracker-theme', tv);
                        }
                        var flavorClass = Array.from(root.classList).find(function (c) { return c && c.indexOf('flavor-') === 0; });
                        if (flavorClass) {
                            localStorage.setItem('tracker-flavor', flavorClass.replace('flavor-', ''));
                        }
                    } catch (err) { }
                });
                try { mo.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] }); } catch (e) { }
            } catch (e) { }
        })();
    </script>


</body>

</html>